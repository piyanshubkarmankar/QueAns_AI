<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>QueAns AI — Premium (Intro · Login · Stable AI)</title>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600;700;800&family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
<style>
:root{
  --bg-1:#030305; --bg-2:#0b0b0d;
  --gold1:#ffd97a; --gold2:#c78f22;
  --muted:#9ea1a6;
  --glass: rgba(255,255,255,0.03);
  --panel: rgba(10,10,12,0.48);
}
*{box-sizing:border-box}
html,body{height:100%;margin:0;font-family:"Poppins",system-ui,-apple-system,"Segoe UI",Roboto,Arial;color:#fffdf7;background: radial-gradient(800px 400px at 8% 8%, rgba(199,143,34,0.02), transparent), linear-gradient(180deg,var(--bg-1),var(--bg-2)); -webkit-font-smoothing:antialiased;overflow:hidden}

/* common */
.screen{width:100vw;height:100vh;display:flex;align-items:center;justify-content:center;padding:28px}

/* Intro */
#introScreen{flex-direction:row; gap:40px; background: linear-gradient(180deg, rgba(0,0,0,0.78), rgba(0,0,0,0.9)); position:relative}
.intro-card{max-width:980px;width:100%;padding:36px;border-radius:18px;background: linear-gradient(180deg, rgba(0,0,0,0.28), rgba(0,0,0,0.36));border:1px solid rgba(255,255,255,0.02);box-shadow: 0 60px 140px rgba(0,0,0,0.7);transform-origin:center;animation:introPop .9s cubic-bezier(.2,.9,.2,1) both}
@keyframes introPop{from{opacity:0;transform:translateY(16px) scale(.995)}to{opacity:1;transform:translateY(0) scale(1)}}
.logo-row{display:flex;gap:16px;align-items:center}
.logo-badge{width:84px;height:84px;border-radius:18px;display:flex;align-items:center;justify-content:center;background: linear-gradient(180deg, rgba(255,217,120,0.10), rgba(199,143,34,0.04));border:1px solid rgba(255,217,120,0.06);box-shadow: 0 18px 60px rgba(199,143,34,0.06);animation:badgeFloat 3.8s ease-in-out infinite}
@keyframes badgeFloat{0%{transform:translateY(-6px)}50%{transform:translateY(4px)}100%{transform:translateY(-6px)}}
.app-title{font-family:"Playfair Display",serif;font-size:44px;font-weight:800;line-height:1;margin:0;background:linear-gradient(90deg,var(--gold1),#ffe7a9,var(--gold2));-webkit-background-clip:text;-webkit-text-fill-color:transparent;filter:drop-shadow(0 10px 28px rgba(199,143,34,0.12));animation:titleGlow 3.8s ease-in-out infinite}
@keyframes titleGlow{0%{filter:drop-shadow(0 6px 16px rgba(199,143,34,0.09))}50%{filter:drop-shadow(0 18px 40px rgba(199,143,34,0.16))}100%{filter:drop-shadow(0 6px 16px rgba(199,143,34,0.09))}}
.intro-sub{margin-top:12px;color:rgba(255,235,180,0.92);font-size:16px;line-height:1.45;max-width:720px;opacity:0;transform:translateY(8px);animation:subAppear .75s ease forwards .25s}
@keyframes subAppear{to{opacity:1;transform:translateY(0)}}
.left-decor{position:absolute;right:-120px;top:-80px;width:420px;height:420px;background:radial-gradient(circle at 30% 30%, rgba(255,210,120,0.06), transparent 12%), radial-gradient(circle at 80% 80%, rgba(199,143,34,0.03), transparent 18%);transform:rotate(18deg);filter:blur(8px);pointer-events:none;opacity:0;animation:decorFadeIn 1.2s ease forwards .15s}
@keyframes decorFadeIn{to{opacity:1}}
.ripple{width:160px;height:8px;margin:12px 0 0;border-radius:12px;background:linear-gradient(90deg, rgba(255,217,120,0.55), rgba(199,143,34,0.55));filter:blur(8px);opacity:0;animation:rippleIn .9s ease forwards .45s}
@keyframes rippleIn{to{opacity:1}}
.btn-primary{background:linear-gradient(90deg,var(--gold1),var(--gold2));color:#0b0905;padding:12px 26px;border-radius:12px;border:0;font-weight:800;cursor:pointer;box-shadow:0 20px 60px rgba(199,143,34,0.12);transition:transform .18s ease,box-shadow .18s ease}
.btn-primary:hover{transform:translateY(-4px);box-shadow:0 28px 80px rgba(199,143,34,0.16)}
.btn-ghost{background:transparent;color:var(--muted);padding:10px 14px;border-radius:10px;border:1px solid rgba(255,255,255,0.02);cursor:pointer;transition:transform .12s ease}
.btn-ghost:hover{transform:translateY(-3px)}

/* login screen */
#loginScreen{display:none;align-items:stretch;justify-content:center;gap:28px;padding:28px}
.split{width:100%;max-width:1100px;display:flex;gap:28px;align-items:center;justify-content:center}
.split-left{flex:1;padding:20px;transform:translateX(-18px);opacity:0;transition:all .7s cubic-bezier(.2,.9,.2,1)}
.split-left.show{transform:translateX(0);opacity:1}
.split-right{width:420px;display:flex;align-items:center;justify-content:center;transform:translateX(18px);opacity:0;transition:all .7s cubic-bezier(.2,.9,.2,1)}
.split-right.show{transform:translateX(0);opacity:1}
.glass-card{width:100%;max-width:420px;border-radius:14px;padding:18px;background: linear-gradient(180deg, rgba(20,20,22,0.86), rgba(8,8,10,0.92));border:1px solid rgba(255,215,120,0.06);box-shadow:0 30px 90px rgba(0,0,0,0.85);color:#fffdf7;backdrop-filter:blur(8px);transform-origin:center;transform:translateY(8px);opacity:0;transition:all .6s cubic-bezier(.2,.9,.2,1)}
.glass-card.show{transform:translateY(0);opacity:1;box-shadow:0 40px 120px rgba(0,0,0,0.9)}
.auth-title{font-family:"Playfair Display",serif;font-size:20px;font-weight:700;background:linear-gradient(90deg,var(--gold1),var(--gold2));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.tabs{display:flex;gap:8px;margin-top:12px}
.tab{padding:8px 12px;border-radius:10px;cursor:pointer;font-weight:700;color:var(--muted);border:1px solid rgba(255,255,255,0.02);transition:all .18s ease}
.tab.active{background:linear-gradient(90deg, rgba(255,217,120,0.08), rgba(199,143,34,0.04));color:#fffdf7;border:1px solid rgba(255,217,120,0.08);transform:translateY(-2px);box-shadow:0 10px 30px rgba(199,143,34,0.06)}
label{display:block;font-weight:700;color:#fff7e6;font-size:13px;margin-bottom:6px}
input{width:100%;padding:12px;border-radius:10px;border:1px solid rgba(255,255,255,0.03);background:transparent;color:#fffdf7;outline:none;transition:box-shadow .18s ease,border-color .18s ease}
input::placeholder{color:rgba(255,255,255,0.45)}
input:focus{box-shadow:0 12px 36px rgba(199,143,34,0.08);border-color:rgba(255,217,120,0.14);transform:translateY(-2px)}
.btn-gold{background:linear-gradient(90deg,var(--gold1),var(--gold2));color:#0b0703;padding:10px 12px;border-radius:10px;border:1px solid rgba(255,255,255,0.06);font-weight:800;cursor:pointer;box-shadow:0 12px 34px rgba(199,143,34,0.07);transition:transform .12s ease}
.btn-gold:hover{transform:translateY(-4px);box-shadow:0 20px 56px rgba(199,143,34,0.12)}
.btn-ghost-small{background:transparent;color:var(--muted);padding:9px 12px;border-radius:10px;border:1px solid rgba(255,255,255,0.02);cursor:pointer;transition:transform .12s ease}
.btn-ghost-small:hover{transform:translateY(-3px)}

/* AI screen (stable old interface - Theme B) */
#aiScreen{display:none;align-items:center;justify-content:center;padding:36px;overflow:auto;animation:aiBgFade .7s ease both}
@keyframes aiBgFade{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
.ai-wrap{width:100%;max-width:980px;transform:translateY(10px);opacity:0;transition:all .7s cubic-bezier(.2,.9,.2,1)}
.ai-wrap.show{transform:translateY(0);opacity:1}
.glass-panel{border-radius:14px;padding:22px;background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.008));border:1px solid rgba(255,255,255,0.03);box-shadow:0 40px 100px rgba(0,0,0,0.75);position:relative;overflow:hidden;animation:panelFloat 6s ease-in-out infinite}
@keyframes panelFloat{0%{transform:translateY(0)}50%{transform:translateY(-6px)}100%{transform:translateY(0)}}
.gold-sheen{position:absolute;right:-160px;top:-120px;width:480px;height:480px;background:radial-gradient(circle at 30% 30%, rgba(255,210,120,0.06), transparent 12%), radial-gradient(circle at 80% 80%, rgba(199,143,34,0.04), transparent 18%);transform:rotate(18deg);filter:blur(10px);transition:all .9s ease}
.glass-panel:hover .gold-sheen{transform:rotate(15deg) translateY(-6px);filter:blur(6px)}
.header{display:flex;align-items:center;justify-content:space-between;gap:12px}
.brand{display:flex;gap:14px;align-items:center}
.vault-badge{width:64px;height:64px;border-radius:14px;display:flex;align-items:center;justify-content:center;background:linear-gradient(180deg, rgba(255,210,120,0.10), rgba(199,143,34,0.04));border:1px solid rgba(255,210,120,0.06);box-shadow:0 10px 40px rgba(199,143,34,0.06)}
.app-name{font-family:"Playfair Display",serif;font-size:20px;font-weight:800;background:linear-gradient(90deg,var(--gold1), #ffe7a9, var(--gold2));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.app-sub{color:var(--muted);font-size:13px}
.cols{display:flex;gap:18px;margin-top:18px;align-items:flex-start}
.main{flex:1;min-width:0}
.side{width:320px}
.card{background:var(--panel);border-radius:12px;padding:14px;border:1px solid rgba(255,255,255,0.02);box-shadow:0 16px 44px rgba(0,0,0,0.6);backdrop-filter:blur(8px) saturate(120%)}
.label{color:#fff7e6;font-weight:700;font-size:13px}
.muted{color:var(--muted);font-size:13px}
textarea{width:100%;background:transparent;border:1px solid rgba(255,255,255,0.03);padding:12px;border-radius:10px;color:#fffdf7;min-height:140px;resize:vertical}
textarea::placeholder{color:rgba(255,255,255,0.45)}
textarea:focus{box-shadow:0 12px 34px rgba(199,143,34,0.08);border-color:rgba(255,217,120,0.12)}
.btn-gold-wide{background:linear-gradient(90deg,var(--gold1),var(--gold2));color:#0b0703;padding:12px 16px;border-radius:12px;border:1px solid rgba(255,255,255,0.06);font-weight:800;cursor:pointer;position:relative;overflow:hidden}
.btn-gold-wide:active::after{content:'';position:absolute;left:50%;top:50%;width:8px;height:8px;transform:translate(-50%,-50%);border-radius:50%;background:rgba(255,255,255,0.12);animation:ripple 0.6s ease forwards;pointer-events:none}
@keyframes ripple{from{width:8px;height:8px;opacity:0.8}to{width:380px;height:380px;opacity:0}}
.tiny{font-size:12px;color:var(--muted)}
.answer-wrap{margin-top:14px;border-radius:12px;padding:14px;background: linear-gradient(180deg, rgba(255,245,230,0.02), rgba(255,255,255,0.003));border:1px solid rgba(255,255,255,0.02);color:#fff9ec;max-height:420px;overflow:auto}
.status{font-size:13px;color:var(--muted)}

/* help modal */
#helpModal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;z-index:900;background:linear-gradient(180deg, rgba(0,0,0,0.6), rgba(0,0,0,0.75))}
.help-card{width:92%;max-width:720px;background:linear-gradient(180deg,#0b0b0d,#070607);padding:18px;border-radius:12px;border:1px solid rgba(255,255,255,0.03);box-shadow:0 30px 90px rgba(0,0,0,0.8);color:#fffdf7}

/* responsive */
@media (max-width:980px){
  .split{flex-direction:column}
  .left-decor{display:none}
  .intro-card{padding:20px}
  .logo-badge{width:64px;height:64px}
}
</style>
</head>
<body>
  <!-- INTRO -->
  <div id="introScreen" class="screen" aria-hidden="false">
    <div class="intro-card" role="region" aria-label="Intro">
      <div class="logo-row">
        <div class="logo-badge" aria-hidden>
          <svg width="44" height="44" viewBox="0 0 24 24" fill="none" aria-hidden>
            <circle cx="12" cy="12" r="8" stroke="url(#g1)" stroke-width="1.2"/>
            <path d="M12 7v4l3 1" stroke="url(#g1)" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"/>
            <defs><linearGradient id="g1" x1="0" x2="1"><stop offset="0" stop-color="#ffd97a"/><stop offset="1" stop-color="#c78f22"/></linearGradient></defs>
          </svg>
        </div>
        <div>
          <h1 class="app-title">QueAns AI</h1>
          <div class="intro-sub">Premium black & gold Q&A — secure, private and elegant. Click Enter to proceed to login.</div>
          <div class="ripple" aria-hidden></div>
        </div>
      </div>

      <div style="margin-top:22px;">
        <button id="enterBtn" class="btn-primary" aria-label="Enter QueAns AI">Enter →</button>
        <button id="introHelp" class="btn-ghost" style="margin-left:12px">How it works</button>
      </div>

      <div style="margin-top:14px;color:var(--muted);font-size:13px;">Tip: Accounts & API keys remain in your browser (localStorage). Use your OpenAI key for full features.</div>
    </div>
    <div class="left-decor" aria-hidden></div>
  </div>

  <!-- LOGIN -->
  <div id="loginScreen" class="screen" style="display:none;">
    <div class="split" role="region" aria-label="Login screen">
      <div class="split-left" id="leftPanel">
        <div style="max-width:520px; opacity:0; transform:translateX(-12px); transition:all .7s cubic-bezier(.2,.9,.2,1);">
          <div style="font-family:'Playfair Display', serif; font-size:36px; font-weight:800; margin-bottom:12px; background:linear-gradient(90deg,var(--gold1),var(--gold2)); -webkit-background-clip:text; -webkit-text-fill-color:transparent;">QueAns AI</div>
          <div style="color:rgba(255,235,180,0.9); font-size:15px; line-height:1.45;">Sign in or create an account to store local settings and use your OpenAI API key. Data stays on this device.</div>
        </div>
      </div>

      <div class="split-right" id="rightPanel">
        <div class="glass-card" id="authCard" role="dialog" aria-modal="true" aria-labelledby="authTitle">
          <div class="auth-header">
            <div>
              <div id="authTitle" class="auth-title">Sign in to QueAns AI</div>
              <div class="small-muted">Create account, sign in, or continue as guest.</div>
            </div>
            <div id="authUserDisplay"></div>
          </div>

          <div class="tabs" role="tablist" aria-label="auth tabs">
            <div id="tabLogin" class="tab active" role="tab" aria-selected="true">Login</div>
            <div id="tabSignup" class="tab" role="tab">Create Account</div>
          </div>

          <div id="loginBox" style="margin-top:12px;">
            <div class="input-row">
              <label>Username</label>
              <input id="loginUser" type="text" autocomplete="username" placeholder="username" />
            </div>
            <div class="input-row">
              <label>Password</label>
              <input id="loginPass" type="password" autocomplete="current-password" placeholder="password" />
            </div>

            <div class="auth-actions" style="margin-top:12px;display:flex;gap:10px;">
              <button id="loginBtn" class="btn-gold" style="flex:1">Login</button>
              <button id="guestBtn" class="btn-ghost-small">Continue as Guest</button>
            </div>
          </div>

          <div id="signupBox" style="display:none; margin-top:12px;">
            <div class="input-row"><label>Username</label><input id="signupUser" type="text" placeholder="choose username" /></div>
            <div class="input-row"><label>Display name (optional)</label><input id="signupDisplay" type="text" placeholder="how you'll appear" /></div>
            <div class="input-row"><label>Password</label><input id="signupPass" type="password" placeholder="create a password" /></div>

            <div class="auth-actions" style="margin-top:12px;display:flex;gap:10px;">
              <button id="createBtn" class="btn-gold" style="flex:1">Create Account</button>
              <button id="backToLogin" class="btn-ghost-small">Back</button>
            </div>
          </div>

          <div class="small-note" style="margin-top:12px;">Passwords hashed with SHA-256 in your browser. Data stays local to your device.</div>
        </div>
      </div>
    </div>
  </div>

  <!-- AI (stable old interface: theme B) -->
  <div id="aiScreen" class="screen" style="display:none; overflow:auto;">
    <div class="ai-wrap" id="aiWrap">
      <div class="glass-panel" role="main" aria-label="AI interface">
        <div class="gold-sheen" aria-hidden></div>

        <div class="header">
          <div class="brand">
            <div class="vault-badge" aria-hidden>
              <svg width="36" height="36" viewBox="0 0 24 24" fill="none" aria-hidden>
                <circle cx="12" cy="12" r="8" stroke="url(#g2)" stroke-width="1.2"></circle>
                <path d="M12 8v3l2 1" stroke="url(#g2)" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"></path>
                <defs><linearGradient id="g2" x1="0" x2="1"><stop offset="0" stop-color="#ffd97a"/><stop offset="1" stop-color="#c78f22"/></linearGradient></defs>
              </svg>
            </div>
            <div>
              <div class="app-name">QueAns AI</div>
              <div class="app-sub tiny" id="userGreeting">Black • Gold • Premium</div>
            </div>
          </div>

          <div style="display:flex;gap:10px;align-items:center;">
            <div class="tiny" id="modelLabel">Model: <strong style="background:linear-gradient(90deg,var(--gold1),var(--gold2)); -webkit-background-clip:text; -webkit-text-fill-color:transparent;">gpt-4o-mini</strong></div>
            <button id="openHelpBtn" class="btn-ghost">Help</button>
            <div id="authControls" style="display:flex;gap:8px;align-items:center;">
              <div id="loggedInAs" class="tiny" style="color:var(--gold1);"></div>
              <button id="logoutBtn" class="btn-ghost" style="display:none;">Logout</button>
            </div>
          </div>
        </div>

        <div class="cols">
          <div class="main">
            <div class="card">
              <div style="display:flex;justify-content:space-between;align-items:center;">
                <div>
                  <div class="label">Ask the AI</div>
                  <div class="muted" style="margin-top:6px">Type a clear question for focused answers (Ctrl/Cmd+Enter to submit).</div>
                </div>
                <div class="tiny" id="charCount">0/900</div>
              </div>

              <div style="margin-top:12px;">
                <textarea id="question" rows="6" maxlength="900" placeholder="e.g. Explain thermodynamics in simple points..."></textarea>
              </div>

              <div style="display:flex;gap:12px;margin-top:12px;align-items:center;">
                <button id="askBtn" class="btn-gold-wide">Ask</button>
                <button id="newBtn" class="btn-ghost">New</button>
                <button id="copyBtn" class="btn-ghost">Copy</button>
                <div style="margin-left:auto" id="status" class="status">Ready</div>
              </div>

              <div id="answerWrap" class="answer-wrap" style="display:none;">
                <div class="answer-meta">
                  <div style="font-weight:700;">AI Answer</div>
                  <div class="tiny" id="timeStamp">—</div>
                </div>

                <div id="answerText" style="margin-top:12px; line-height:1.6;"></div>

                <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:12px;">
                  <button id="copyAnswerBtn" class="btn-ghost">Copy Answer</button>
                  <button id="closeAnswerBtn" class="btn-ghost">Close</button>
                </div>
              </div>
            </div>
          </div>

          <div class="side">
            <div class="card" style="margin-bottom:12px;">
              <div class="label">API Key (local)</div>
              <div class="muted" style="margin-top:6px">Paste your OpenAI secret key here (starts with <code>sk-</code>). Stored only in this browser.</div>

              <div style="margin-top:12px;display:flex;gap:8px;align-items:center;">
                <input id="apiKeyInput" type="password" placeholder="sk-..." />
              </div>

              <div style="display:flex;gap:8px;margin-top:12px;">
                <button id="saveKeyBtn" class="btn-gold" style="padding:8px 12px;font-size:13px;">Save Key</button>
                <button id="clearKeyBtn" class="btn-ghost" style="padding:8px 12px;font-size:13px;">Clear</button>
              </div>
            </div>

            <div class="card">
              <div class="label">Account</div>
              <div class="muted" style="margin-top:8px" id="accountInfo">Manage your local account settings (stored here).</div>

              <div style="display:flex;gap:8px;margin-top:12px;">
                <button id="manageBtn" class="btn-ghost">Manage Accounts</button>
                <button id="logoutBtnBottom" class="btn-ghost" style="margin-left:auto;display:none;">Logout</button>
              </div>
            </div>
          </div>
        </div>

      </div>
    </div>
  </div>

  <!-- Help Modal -->
  <div id="helpModal">
    <div class="help-card">
      <div style="display:flex;justify-content:space-between;align-items:center;">
        <div style="font-weight:700;font-size:18px;color:var(--gold1);">How to get your OpenAI API key</div>
        <div style="font-size:22px;color:var(--gold1);cursor:pointer" id="closeHelpBtn">✕</div>
      </div>

      <div style="margin-top:12px;color:#fffdf7;line-height:1.6;">
        <ol>
          <li>Open <code>https://platform.openai.com</code> and sign in.</li>
          <li>Go to 'View API keys' / 'Create new secret key'.</li>
          <li>Copy the key (it starts with <code>sk-</code>) and paste it into the field — it is stored locally in your browser only.</li>
        </ol>
        <p style="margin-top:10px;color:var(--gold1);font-weight:600;">Security tip: never paste your key in public chats or share it.</p>
      </div>
    </div>
  </div>

<script>
/* Utilities */
const $ = id => document.getElementById(id);

/* Screens */
const introScreen = $('introScreen'), loginScreen = $('loginScreen'), aiScreen = $('aiScreen');
const leftPanel = $('leftPanel'), rightPanel = $('rightPanel'), authCard = $('authCard'), aiWrap = $('aiWrap');

/* Intro -> Login */
$('enterBtn').addEventListener('click', ()=>{
  introScreen.style.transition = 'opacity .6s ease, transform .6s ease';
  introScreen.style.opacity = '0';
  introScreen.style.transform = 'translateX(-20px) scale(.995)';
  setTimeout(()=> {
    introScreen.style.display = 'none';
    loginScreen.style.display = 'flex';
    setTimeout(()=> { leftPanel.querySelector('div').classList.add('show'); rightPanel.classList.add('show'); authCard.classList.add('show'); }, 80);
    window.scrollTo(0,0);
  }, 520);
});

$('introHelp').addEventListener('click', ()=> openHelp());
$('openHelpBtn').addEventListener('click', ()=> openHelp());
$('closeHelpBtn') && $('closeHelpBtn').addEventListener('click', ()=> closeHelp());

/* Tabs */
const tabLogin = $('tabLogin'), tabSignup = $('tabSignup'), loginBox = $('loginBox'), signupBox = $('signupBox');
tabLogin.addEventListener('click', ()=> { tabLogin.classList.add('active'); tabSignup.classList.remove('active'); loginBox.style.display='block'; signupBox.style.display='none'; });
tabSignup.addEventListener('click', ()=> { tabSignup.classList.add('active'); tabLogin.classList.remove('active'); signupBox.style.display='block'; loginBox.style.display='none'; });

/* Elements */
const loginUser = $('loginUser'), loginPass = $('loginPass'), loginBtn = $('loginBtn'), guestBtn = $('guestBtn');
const signupUser = $('signupUser'), signupPass = $('signupPass'), signupDisplay = $('signupDisplay'), createBtn = $('createBtn'), backToLogin = $('backToLogin');
const authUserDisplay = $('authUserDisplay');
const userGreeting = $('userGreeting'), loggedInAs = $('loggedInAs');
const logoutBtn = $('logoutBtn'), logoutBtnBottom = $('logoutBtnBottom');
const manageBtn = $('manageBtn');
const accountInfo = $('accountInfo');
const questionEl = $('question'), charCount = $('charCount');
const askBtn = $('askBtn'), newBtn = $('newBtn'), copyBtn = $('copyBtn');
const statusEl = $('status'), answerWrap = $('answerWrap'), answerText = $('answerText'), timeStamp = $('timeStamp');
const apiKeyInput = $('apiKeyInput'), saveKeyBtn = $('saveKeyBtn'), clearKeyBtn = $('clearKeyBtn');
const copyAnswerBtn = $('copyAnswerBtn'), closeAnswerBtn = $('closeAnswerBtn');

/* Hashing */
async function sha256hex(text){
  const enc = new TextEncoder();
  const data = enc.encode(text);
  const hash = await crypto.subtle.digest('SHA-256', data);
  const bytes = Array.from(new Uint8Array(hash));
  return bytes.map(b => b.toString(16).padStart(2,'0')).join('');
}

/* Storage helpers */
function loadAccounts(){ try { return JSON.parse(localStorage.getItem('qa_accounts') || '{}'); } catch { return {}; } }
function saveAccounts(obj){ localStorage.setItem('qa_accounts', JSON.stringify(obj)); }
function setLoggedIn(username){ localStorage.setItem('qa_user', username); }
function getLoggedIn(){ return localStorage.getItem('qa_user'); }
function clearLoggedIn(){ localStorage.removeItem('qa_user'); }

/* UI */
function updateAuthDisplay(){
  const u = getLoggedIn(); const accounts = loadAccounts();
  if (u && accounts[u]) {
    const display = accounts[u].display || u;
    loggedInAs.textContent = display;
    userGreeting.textContent = `Hello, ${display}`;
    logoutBtn.style.display = 'inline-block';
    logoutBtnBottom.style.display = 'inline-block';
    accountInfo.textContent = `Signed in as ${display} (${u}) — manage or logout.`;
  } else if (u) {
    loggedInAs.textContent = u;
    userGreeting.textContent = `Hello, ${u}`;
    logoutBtn.style.display = 'inline-block';
    logoutBtnBottom.style.display = 'inline-block';
  } else {
    loggedInAs.textContent = '';
    userGreeting.textContent = 'Black • Gold • Premium';
    logoutBtn.style.display = 'none';
    logoutBtnBottom.style.display = 'none';
    accountInfo.textContent = 'Manage your local account settings (stored here).';
  }
}

/* Create account */
createBtn.addEventListener('click', async ()=>{
  const username = signupUser.value.trim();
  const pass = signupPass.value;
  const disp = signupDisplay.value.trim() || username;
  if (!username) return alert('Username required.');
  if (!pass) return alert('Password required.');
  const accounts = loadAccounts();
  if (accounts[username]) return alert('Username already exists.');
  const hash = await sha256hex(pass);
  accounts[username] = { display: disp, passwordHash: hash };
  saveAccounts(accounts);
  setLoggedIn(username);
  alert(`Created and signed in as ${disp}`);
  updateAuthDisplay();
  authCard.classList.remove('show'); rightPanel.classList.remove('show'); leftPanel.querySelector('div').classList.remove('show');
  setTimeout(()=> showAI(), 300);
});

/* Login */
loginBtn.addEventListener('click', async ()=>{
  const username = loginUser.value.trim();
  const pass = loginPass.value;
  if (!username) return alert('Enter username.');
  if (!pass) return alert('Enter password.');
  const accounts = loadAccounts();
  if (!accounts[username]) return alert('No such user.');
  const hash = await sha256hex(pass);
  if (hash !== accounts[username].passwordHash) return alert('Incorrect password.');
  setLoggedIn(username);
  alert('Welcome back, ' + (accounts[username].display || username));
  updateAuthDisplay();
  authCard.classList.remove('show'); rightPanel.classList.remove('show'); leftPanel.querySelector('div').classList.remove('show');
  setTimeout(()=> showAI(), 300);
});

/* Guest */
guestBtn.addEventListener('click', ()=>{
  const guest = 'guest_' + Math.random().toString(36).slice(2,8);
  const accounts = loadAccounts();
  accounts[guest] = { display: 'Guest', passwordHash: '' };
  saveAccounts(accounts);
  setLoggedIn(guest);
  updateAuthDisplay();
  authCard.classList.remove('show'); rightPanel.classList.remove('show'); leftPanel.querySelector('div').classList.remove('show');
  setTimeout(()=> showAI(), 300);
});

/* Logout */
logoutBtn.addEventListener('click', ()=> { clearLoggedIn(); updateAuthDisplay(); alert('Logged out'); showLogin(); });
logoutBtnBottom.addEventListener('click', ()=> { clearLoggedIn(); updateAuthDisplay(); alert('Logged out'); showLogin(); });

/* Show screens */
function showLogin(){
  introScreen.style.display = 'none';
  loginScreen.style.display = 'flex';
  aiScreen.style.display = 'none';
  setTimeout(()=> { leftPanel.querySelector('div').classList.add('show'); rightPanel.classList.add('show'); authCard.classList.add('show'); }, 60);
  window.scrollTo(0,0);
}
function showAI(){
  introScreen.style.display = 'none';
  loginScreen.style.display = 'none';
  aiScreen.style.display = 'flex';
  setTimeout(()=> { aiWrap.classList.add('show'); }, 80);
  window.scrollTo(0,0);
}

/* help modal */
function openHelp(){ $('helpModal').style.display = 'flex'; }
function closeHelp(){ $('helpModal').style.display = 'none'; }

/* Load saved API key */
window.addEventListener('load', ()=> {
  const k = localStorage.getItem('OPENAI_KEY');
  if (k) { apiKeyInput.value = k; statusEl.textContent = 'API key loaded (local)'; } else statusEl.textContent = 'Ready';
  updateAuthDisplay();
});

/* Save / Clear API key */
saveKeyBtn.addEventListener('click', ()=>{
  const v = apiKeyInput.value.trim();
  if (!v) return alert('Paste your OpenAI API key first.');
  if (!v.startsWith('sk-')) { if (!confirm('Key does not start with "sk-". Save anyway?')) return; }
  localStorage.setItem('OPENAI_KEY', v);
  statusEl.textContent = 'API key saved (local)';
  alert('API key saved locally in your browser.');
});
clearKeyBtn.addEventListener('click', ()=> { localStorage.removeItem('OPENAI_KEY'); apiKeyInput.value=''; statusEl.textContent='Key cleared'; });

/* Char count */
questionEl.addEventListener('input', ()=> { charCount.textContent = `${questionEl.value.length}/900`; });

/* Typewriter */
async function typeWriter(text, el, speed=14){
  el.innerHTML = '';
  for (let i=0;i<text.length;i++){ el.innerHTML += text.charAt(i); el.scrollTop = el.scrollHeight; await new Promise(r=>setTimeout(r, speed)); }
}

/* Extract text helper */
function extractResponseText(data){
  if (!data) return '';
  if (typeof data === 'string') return data;
  if (data.output_text) return data.output_text;
  if (Array.isArray(data.output) && data.output.length){
    const out = data.output.map(o=>{
      if (typeof o === 'string') return o;
      if (Array.isArray(o.content)) return o.content.map(c=>c.text||'').join('');
      return o.text || o.output_text || '';
    }).join('\n');
    if (out.trim()) return out;
  }
  if (data.choices && data.choices.length) return data.choices[0].message?.content || data.choices[0].text || '';
  if (data.results && data.results.length){
    const r = data.results[0];
    if (r.output_text) return r.output_text;
    if (r.output && Array.isArray(r.output)) return r.output.map(x => Array.isArray(x.content)? x.content.map(c=>c.text||'').join('') : (x.text||'')).join('\n');
  }
  try { return JSON.stringify(data, null, 2); } catch(e){ return String(data); }
}

/* Ask logic (Responses -> Chat completions) */
askBtn.addEventListener('click', async ()=>{
  const q = questionEl.value.trim();
  if (!q) { alert('Please type a question.'); return; }
  const key = localStorage.getItem('OPENAI_KEY') || apiKeyInput.value.trim();
  if (!key) { alert('Please provide your OpenAI API key and Save it.'); return; }

  askBtn.disabled = true; askBtn.textContent = 'Thinking...';
  statusEl.textContent = 'Sending...';
  answerWrap.style.display = 'block';
  answerText.innerHTML = '<div style="height:14px;width:160px;background:linear-gradient(90deg, rgba(199,143,34,0.12), rgba(255,217,120,0.06));border-radius:6px;"></div>';
  timeStamp.textContent = new Date().toLocaleTimeString();

  try {
    let responseData = null;
    try {
      const r = await fetch('https://api.openai.com/v1/responses', {
        method:'POST',
        headers:{ 'Content-Type':'application/json', 'Authorization':'Bearer ' + key },
        body: JSON.stringify({ model:'gpt-4o-mini', input: q })
      });
      responseData = await r.json();
      if (responseData?.error) throw new Error(responseData.error?.message || 'Responses API error');
    } catch (errResp) {
      statusEl.textContent = 'Responses failed — falling back...';
      const r2 = await fetch('https://api.openai.com/v1/chat/completions', {
        method:'POST',
        headers:{ 'Content-Type':'application/json', 'Authorization':'Bearer ' + key },
        body: JSON.stringify({ model:'gpt-4o-mini', messages:[{role:'user', content:q}], max_tokens:700 })
      });
      responseData = await r2.json();
    }

    const text = extractResponseText(responseData) || 'No answer received.';
    statusEl.textContent = 'Answer received';
    await typeWriter(text, answerText, 14);

  } catch (err) {
    console.error(err);
    answerText.textContent = 'Error: ' + (err?.message || String(err));
    statusEl.textContent = 'Error';
  } finally {
    askBtn.disabled = false; askBtn.textContent = 'Ask';
  }
});

/* keyboard submit */
questionEl.addEventListener('keydown', (e)=>{ if ((e.ctrlKey||e.metaKey) && e.key==='Enter') askBtn.click(); });

/* New / Copy / Copy answer / Close */
newBtn.addEventListener('click', ()=> { questionEl.value=''; charCount.textContent='0/900'; answerWrap.style.display='none'; answerText.innerHTML=''; statusEl.textContent='Ready'; });
copyBtn.addEventListener('click', async ()=> { const t = answerText.innerText || questionEl.value || ''; try { await navigator.clipboard.writeText(t); statusEl.textContent='Copied'; } catch { alert('Copy failed — allow clipboard permission.'); } });
copyAnswerBtn && copyAnswerBtn.addEventListener('click', async ()=> { try { await navigator.clipboard.writeText(answerText.innerText || ''); statusEl.textContent = 'Answer copied'; } catch { alert('Copy failed'); } });
closeAnswerBtn && closeAnswerBtn.addEventListener('click', ()=> answerWrap.style.display='none');

/* manage button */
manageBtn.addEventListener('click', ()=> { showLogin(); });

/* initial state: per your choice (C) always show intro first */
introScreen.style.display = 'flex';
loginScreen.style.display = 'none';
aiScreen.style.display = 'none';
updateAuthDisplay();
</script>
</body>
</html>




